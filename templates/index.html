{% extends 'base.html' %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='media.css') }}">
{% endblock %}

{% block content %}
    <form action="{{ url_for('home') }}" method="get">
        <input type="text" name="q" placeholder="Search titles..." value="{{ q }}">
        <input type="text" name="sub" placeholder="Subreddit..." value="{{ sub }}">
        <button type="submit">Filter</button>
    </form>

    {% if not posts %}
        <div class="no-posts">
            <span>There aren't any downloaded posts yet...</span>
        </div>
    {% endif %}

    <div>
        {% for post in posts %}
            <div class="post-preview">
                <h2><a href="{{ url_for('view_post', post_id=post['id']) }}">{{ post['title'] }}</a></h2>
                <p class="subreddit-name">• r/{{ post['subreddit'] }}</p>
                <p class="post-author">Posted by: {{ post['author'] }}</p></p>

                <div class="media-container">
                    {% if post['post_type'] == "video" %}
                        <div class="video-wrapper">
                            <video controls>
                                <source src="{{ url_for('serve_media', filename=post['local_media']) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    {% endif %}
                    {% if post['post_type'] == "image" %}
                        <div class="image-wrapper">
                            <img src="{{ url_for('serve_media', filename=post['local_media']) }}">
                        </div>
                    {% endif %}
                    {% if post['post_type'] == "gallery" %}
                        <div class="gallery-wrapper">
                            
                            <div class="gallery-track">
                                {% for image in post['local_media'] %}
                                    <div class="gallery-slide">
                                        <img src="{{ url_for('serve_media', filename=image) }}" alt="Slide {{ loop.index }}">
                                    </div>
                                {% endfor %}
                            </div>

                            <button class="gallery-btn prev" aria-label="Previous Slide" style="display: none;">❮</button>
                            <button class="gallery-btn next" aria-label="Next Slide">❯</button>

                            <div class="gallery-dots">
                                {% for image in post['local_media'] %}
                                    <button class="dot {{ 'active' if loop.first else '' }}" data-index="{{ loop.index0 }}" aria-label="Go to slide {{ loop.index }}"></button>
                                {% endfor %}
                            </div>
                            
                        </div>
                    {% endif %}
                </div>

                {% if post['text'] %}
                    <p class="post-text-preview">{{ post['text'][:200]}} ...</p>
                {% endif %}
                <a class="post-num-comments" href="{{ url_for('view_post', post_id=post['id']) }}">{{ post['num_comments'] }} comments</a>
            </div>
        {% endfor %}
    </div>

    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('home', page=page-1, q=q, sub=sub) }}">Previous</a>
        {% endif %}
        
        <span>Page {{ page }} of {{ total_pages }}</span>

        {% if page < total_pages %}
            <a href="{{ url_for('home', page=page+1, q=q, sub=sub) }}">Next</a>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
        const galleries = document.querySelectorAll('.gallery-wrapper');

        galleries.forEach(wrapper => {
            
            // --- Scoped Selections ---
            const track = wrapper.querySelector('.gallery-track');
            const nextBtn = wrapper.querySelector('.gallery-btn.next');
            const prevBtn = wrapper.querySelector('.gallery-btn.prev');
            const dotsNav = wrapper.querySelector('.gallery-dots');
            
            if (!track || !dotsNav) return;

            const slides = Array.from(track.children);
            const dots = Array.from(dotsNav.children);
            
            // State is local to THIS gallery instance
            let currentIndex = 0;

            const updateGallery = (index) => {
                if (index < 0 || index >= slides.length) return;
                
                // Get width of THIS gallery's slide
                const slideWidth = slides[0].getBoundingClientRect().width;
                
                track.scrollTo({
                    left: slideWidth * index,
                    behavior: 'smooth'
                });

                dots.forEach(d => d.classList.remove('active'));
                if(dots[index]) dots[index].classList.add('active');

                if (prevBtn) prevBtn.style.display = index === 0 ? 'none' : 'block';
                if (nextBtn) nextBtn.style.display = index === slides.length - 1 ? 'none' : 'block';
                
                currentIndex = index;
            };

            // --- Event Listeners (Scoped) ---

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentIndex < slides.length - 1) updateGallery(currentIndex + 1);
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentIndex > 0) updateGallery(currentIndex - 1);
                });
            }

            dotsNav.addEventListener('click', (e) => {
                const targetDot = e.target.closest('.dot');
                if (!targetDot) return;
                const targetIndex = parseInt(targetDot.dataset.index);
                updateGallery(targetIndex);
            });

            // Resize handler (Scoped)
            // We attach the resize event to window, but it updates THIS gallery
            window.addEventListener('resize', () => {
                track.style.scrollBehavior = 'auto';
                updateGallery(currentIndex);
                track.style.scrollBehavior = 'smooth';
            });
        });
    });
    </script>
{% endblock %}